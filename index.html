<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMD - Business Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #f39c12; --secondary: #2980b9; --dark: #1a1a1a;
            --bg: #f0f2f5; --white: #ffffff; --success: #27ae60; --danger: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif; margin: 0;
            background-color: var(--bg); display: flex; flex-direction: column;
            align-items: center; color: #333; transition: 0.3s;
        }

        .user-profile {
            background: white; width: 90%; max-width: 400px; padding: 15px;
            border-radius: 15px; margin-top: 15px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .user-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .user-info h4 { margin: 0; font-size: 16px; color: var(--dark); }
        .user-info p { margin: 2px 0; font-size: 11px; color: #666; }

        .top-bar {
            width: 100%; background: var(--dark); padding: 12px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-sizing: border-box; position: sticky; top: 0; z-index: 1000;
        }

        .phone-frame { width: 95%; max-width: 420px; margin-top: 10px; }
        .desktop-mode { max-width: 1000px !important; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .stat-card { background: white; padding: 12px; border-radius: 10px; border-left: 5px solid #ddd; }
        .stat-card.received { border-color: var(--success); }
        .stat-card.payment { border-color: var(--danger); }
        .stat-label { font-size: 12px; font-weight: bold; color: #555; }
        .stat-value { display: block; font-size: 15px; font-weight: bold; margin-top: 5px; }

        .download-sec { background: white; margin: 10px; padding: 15px; border-radius: 12px; text-align: center; }
        .date-input { padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; }
        .btn-download { background: var(--secondary); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; }

        .product-list { padding: 10px; }
        .product-item { background: white; padding: 12px; border-radius: 10px; margin-bottom: 12px; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .product-item h5 { margin: 0 0 8px 0; color: var(--secondary); border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .prod-detail { display: grid; grid-template-columns: 1fr 1fr; font-size: 12px; gap: 8px; }
        .print-btn-sm { position: absolute; top: 10px; right: 10px; background: var(--success); color: white; border: none; padding: 4px 10px; border-radius: 5px; font-size: 10px; cursor: pointer; }

        .payment-box { border-left: 5px solid #9b59b6 !important; }

        #loginOverlay { position: fixed; inset: 0; background: var(--dark); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 30px; border-radius: 15px; text-align: center; width: 85%; max-width: 350px; }
        
        @media print { .top-bar, .user-profile, .download-sec, .stats-grid { display: none !important; } }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="margin:0 0 15px 0;">Account Login</h2>
            <input type="tel" id="loginPhone" placeholder="Registered Mobile Number" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; font-size: 16px;">
            <button onclick="handleLogin()" style="width:100%; background:var(--primary); color:white; border:none; padding:12px; margin-top:15px; border-radius:8px; font-weight:bold; cursor:pointer;">VERIFY & LOGIN</button>
            <p id="errorMsg" style="color:red; font-size:12px; display:none; margin-top:10px;"></p>
        </div>
    </div>

    <div class="top-bar" id="navBar" style="display:none;">
        <button onclick="handleLogout()" style="background:var(--danger); color:white; border:none; padding:5px 12px; border-radius:15px; cursor:pointer;">Logout</button>
        <button onclick="toggleView()" style="background:rgba(255,255,255,0.1); color:white; border:1px solid grey; padding:5px 12px; border-radius:15px; cursor:pointer;">Desktop View</button>
    </div>

    <div class="phone-frame" id="mainFrame" style="display:none;">
        
        <div class="user-profile">
            <img src="https://via.placeholder.com/60" id="userImg" class="user-avatar">
            <div class="user-info">
                <h4 id="userName">Loading...</h4>
                <p id="userAddr">Address loading...</p>
                <p id="userMob">Mobile: 0000000000</p>
            </div>
        </div>

        <header><h1>Business Dashboard</h1></header>

        <div class="stats-grid">
            <div class="stat-card received"><span class="stat-label">মোট জমা</span><span class="stat-value" id="totalReceived">₹ 0.00</span></div>
            <div class="stat-card payment"><span class="stat-label">মোট খরচ</span><span class="stat-value" id="totalPayment">₹ 0.00</span></div>
            <div class="stat-card balance"><span class="stat-label">নিট ক্যাশ</span><span class="stat-value" id="totalPrice">₹ 0.00</span></div>
            <div class="stat-card due"><span class="stat-label">মোট বাকি</span><span class="stat-value" id="paymentStatus">₹ 0.00</span></div>
        </div>

        <div class="download-sec">
            <h4 style="margin:0 0 10px 0;">Download Report</h4>
            <div style="display:flex; gap:5px; justify-content:center;">
                <input type="date" id="startDate" class="date-input">
                <input type="date" id="endDate" class="date-input">
            </div>
            <button class="btn-download" onclick="downloadStatement()"><i class="fas fa-file-pdf"></i> Get PDF Statement</button>
        </div>

        <h3 style="padding: 0 15px; font-size: 16px; color: #555;">Live Activity List:</h3>
        <div class="product-list" id="productContainer">
            </div>

    </div>

    <script>
        let currentUser = null;

        // --- Persistent Login Check ---
        window.onload = function() {
            const savedUser = localStorage.getItem('bmd_user');
            if (savedUser) {
                showDashboard(JSON.parse(savedUser));
            }
        };

        async function handleLogin() {
            const phone = document.getElementById('loginPhone').value.trim();
            if(!phone) return;

            const { data, error } = await supabaseClient.from('accounts').select('*').eq('mobile', phone);
            
            if (data && data.length > 0) {
                const user = data[0];
                localStorage.setItem('bmd_user', JSON.stringify(user));
                showDashboard(user);
            } else {
                document.getElementById('errorMsg').innerText = "Account not found!";
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        function handleLogout() {
            localStorage.removeItem('bmd_user');
            location.reload();
        }

        function showDashboard(user) {
            currentUser = user;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainFrame').style.display = 'block';
            document.getElementById('navBar').style.display = 'flex';
            
            document.getElementById('userName').innerText = currentUser.name;
            document.getElementById('userAddr').innerText = `${currentUser.address}, ${currentUser.pin}, ${currentUser.state}`;
            document.getElementById('userMob').innerText = "Mobile: " + currentUser.mobile;
            if(currentUser.image_url) document.getElementById('userImg').src = currentUser.image_url;

            fetchDashboardData();
        }

        async function fetchDashboardData() {
            const { data: trans } = await supabaseClient.from('transactions').select('*').order('created_at', { ascending: false });
            const { data: pays } = await supabaseClient.from('payments').select('*').order('created_at', { ascending: false });

            let cashIn = 0, cashOut = 0, totalDue = 0;
            let combinedHtml = '';

            // 1. Process Product Transactions
            if(trans) {
                trans.forEach((item, index) => {
                    cashIn += parseFloat(item.paid_amount || 0);
                    totalDue += parseFloat(item.due_amount || 0);

                    combinedHtml += `
                    <div class="product-item">
                        <h5><i class="fas fa-box"></i> Product Received #${index + 1}</h5>
                        <button class="print-btn-sm" onclick="printInvoice(${JSON.stringify(item).replace(/"/g, '&quot;')})">Print</button>
                        <div class="prod-detail">
                            <span>Qty: <b>${item.quantity}</b></span>
                            <span>Date: <b>${new Date(item.created_at).toLocaleDateString()}</b></span>
                            <span>Total: <b>₹${item.total_price}</b></span>
                            <span>Paid: <b style="color:green;">₹${item.paid_amount}</b></span>
                            <span style="grid-column: span 2;">Due: <b style="color:red;">₹${item.due_amount}</b></span>
                        </div>
                    </div>`;
                });
            }

            // 2. Process Online Payments (Live View)
            if(pays) {
                pays.forEach((p) => {
                    let typeColor = p.payment_type === 'took' ? 'green' : 'red';
                    let typeText = p.payment_type === 'took' ? 'Cash In (Recv)' : 'Cash Out (Paid)';
                    
                    if(p.payment_type === 'took') cashIn += parseFloat(p.amount || 0);
                    if(p.payment_type === 'gave') cashOut += parseFloat(p.amount || 0);

                    combinedHtml += `
                    <div class="product-item payment-box">
                        <h5 style="color: #9b59b6;"><i class="fas fa-money-bill-wave"></i> Payment Update</h5>
                        <div class="prod-detail">
                            <span>Type: <b style="color:${typeColor};">${typeText}</b></span>
                            <span>Date: <b>${new Date(p.created_at).toLocaleDateString()}</b></span>
                            <span style="grid-column: span 2;">Amount: <b style="font-size:14px;">₹${p.amount}</b></span>
                            <span style="grid-column: span 2; font-style: italic; color: #888;">Note: ${p.note || 'Online Payment'}</span>
                        </div>
                    </div>`;
                });
            }

            document.getElementById('productContainer').innerHTML = combinedHtml;
            document.getElementById('totalReceived').innerText = "₹ " + cashIn.toLocaleString('en-IN');
            document.getElementById('totalPayment').innerText = "₹ " + cashOut.toLocaleString('en-IN');
            document.getElementById('totalPrice').innerText = "₹ " + (cashIn - cashOut).toLocaleString('en-IN');
            document.getElementById('paymentStatus').innerText = "₹ " + (totalDue - cashOut).toLocaleString('en-IN');
        }

        function printInvoice(item) {
            const printWin = window.open('', '_blank');
            printWin.document.write(`
                <html>
                <head><title>Invoice</title></head>
                <body style="font-family: sans-serif; padding: 40px;">
                    <h1 style="text-align:center;">INVOICE</h1>
                    <div style="margin-bottom:20px;">
                        <strong>Seller:</strong> ${currentUser.name}<br>
                        <strong>Address:</strong> ${currentUser.address}, ${currentUser.state}<br>
                        <strong>Mobile:</strong> ${currentUser.mobile}
                    </div>
                    <table border="1" style="width:100%; border-collapse:collapse; text-align:center;">
                        <tr><th>Description</th><th>Qty</th><th>Price</th><th>Paid</th><th>Due</th></tr>
                        <tr><td>Product Order</td><td>${item.quantity}</td><td>₹${item.total_price}</td><td>₹${item.paid_amount}</td><td>₹${item.due_amount}</td></tr>
                    </table>
                    <div style="margin-top:50px; display:flex; justify-content:space-between;">
                        <p>___________________<br>Supplier Signature</p>
                        <p>___________________<br>Seller Signature</p>
                    </div>
                </body>
                </html>
            `);
            printWin.document.close();
            printWin.print();
        }

        function toggleView() {
            document.getElementById('mainFrame').classList.toggle('desktop-mode');
        }

        function downloadStatement() {
            alert("Statement generation started for the selected dates...");
        }
    </script>
</body>
</html>
