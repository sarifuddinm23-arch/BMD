<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>BMD - Payment Ledger</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root { --primary: #f39c12; --dark: #1a1a1a; --bg: #f4f4f9; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); }
        .top-bar { background: var(--dark); padding: 15px; color: white; display: flex; justify-content: space-between; }
        .container { max-width: 900px; margin: 20px auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 0 15px; }
        .box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .balance-card { background: #1a1a1a; color: var(--primary); padding: 15px; border-radius: 8px; text-align: center; }
        .btn-save { background: var(--primary); color: #000; border: none; padding: 15px; width: 100%; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
        .gave { color: #e74c3c; font-weight: bold; } 
        .took { color: #27ae60; font-weight: bold; }
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 210mm; display: flex !important; }
            .inv-box { width: 100mm; border: 1px solid #000; padding: 15px; margin: 5px; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <span onclick="window.location.href='index.html'" style="cursor:pointer;">‚¨ÖÔ∏è DASHBOARD</span>
    <span>PAYMENT ENTRY</span>
</div>

<div class="container">
    <div class="box">
        <div class="balance-card">
            <p>Current Due (‡¶¨‡¶æ‡¶ï‡¶ø)</p>
            <h2 id="currentBalance">‚Çπ 0.00</h2>
        </div>

        <label>Select Party</label>
        <select id="partySelect" onchange="loadPartyBalance()"></select>

        <label>Type</label>
        <select id="pType">
            <option value="took">Money Received (‡¶ü‡¶æ‡¶ï‡¶æ ‡¶®‡¶ø‡ßü‡ßá‡¶õ‡¶ø)</option>
            <option value="gave">Money Paid (‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡¶ø)</option>
        </select>

        <label>Amount</label>
        <input type="number" id="pAmount" placeholder="0.00">

        <label>Note</label>
        <textarea id="pNote" placeholder="‡¶ï‡¶ø ‡¶¨‡¶æ‡¶¨‡¶¶?"></textarea>

        <button class="btn-save" id="saveBtn" onclick="savePayment()">SAVE & PRINT</button>
    </div>

    <div class="box">
        <h3>Recent History</h3>
        <div style="overflow-y: auto; max-height: 400px;">
            <table>
                <thead>
                    <tr><th>Date</th><th>Type</th><th>Amount</th><th>WA</th></tr>
                </thead>
                <tbody id="paymentList"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="printArea" style="display:none;">
    <div class="inv-box" id="p1"></div>
    <div class="inv-box" id="p2"></div>
</div>

<script>
    async function loadParties() {
        const { data } = await supabaseClient.from('parties').select('*');
        const select = document.getElementById('partySelect');
        select.innerHTML = '<option value="">Choose Party</option>';
        data.forEach(p => select.innerHTML += `<option value="${p.id}" data-mob="${p.mobile}">${p.first_name}</option>`);
    }

    async function loadPartyBalance() {
        const partyId = document.getElementById('partySelect').value;
        if(!partyId) return;
        
        // ‡ßß. ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡¶æ‡¶ï‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶æ‡¶ï‡¶ø (Due) ‡¶®‡¶ø‡¶®
        const { data: trans } = await supabaseClient.from('transactions').select('due_amount').eq('party_id', partyId);
        // ‡ß®. ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶ó‡ßá ‡¶Æ‡ßá‡¶ü‡¶æ‡¶®‡ßã ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶®‡¶ø‡¶®
        const { data: pays } = await supabaseClient.from('payments').select('amount, payment_type').eq('party_id', partyId);

        let totalDue = (trans || []).reduce((sum, t) => sum + (parseFloat(t.due_amount) || 0), 0);
        let paidAdjust = (pays || []).reduce((sum, p) => p.payment_type === 'gave' ? sum - parseFloat(p.amount) : sum + parseFloat(p.amount), 0); 
        
        document.getElementById('currentBalance').innerText = "‚Çπ " + (totalDue - paidAdjust).toFixed(2);
    }

    async function savePayment() {
        const btn = document.getElementById('saveBtn');
        const partyId = document.getElementById('partySelect').value;
        const amount = parseFloat(document.getElementById('pAmount').value);
        const type = document.getElementById('pType').value;
        const note = document.getElementById('pNote').value;

        if(!partyId || isNaN(amount)) { alert("‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¶‡¶ø‡¶®!"); return; }

        btn.disabled = true;
        btn.innerText = "Saving...";

        // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá 'payment_type' ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶Ø‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ SQL ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Æ‡¶ø‡¶≤‡¶¨‡ßá
        const { data, error } = await supabaseClient.from('payments').insert([{
            party_id: partyId, 
            amount: amount, 
            payment_type: type, 
            note: note
        }]).select();

        if(error) {
            alert("Error: " + error.message);
        } else {
            alert("Saved! ‚úÖ");
            document.getElementById('pAmount').value = '';
            await loadPartyBalance();
            await fetchPayments();
            preparePrint(data[0]);
        }
        btn.disabled = false;
        btn.innerText = "SAVE & PRINT";
    }

    async function fetchPayments() {
        const { data } = await supabaseClient.from('payments').select('*, parties(first_name, mobile)').order('created_at', {ascending: false});
        const tbody = document.getElementById('paymentList');
        tbody.innerHTML = '';
        data.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${new Date(p.created_at).toLocaleDateString()}</td>
                    <td class="${p.payment_type}">${p.payment_type.toUpperCase()}</td>
                    <td>‚Çπ${p.amount}</td>
                    <td><a href="https://wa.me/91${p.parties?.mobile}?text=Payment%20Received:%20${p.amount}" target="_blank">üü¢</a></td>
                </tr>`;
        });
    }

    function preparePrint(p) {
        const name = document.getElementById('partySelect').options[document.getElementById('partySelect').selectedIndex].text;
        const html = `<h3>BMD RECEIPT</h3><p>Party: ${name}</p><p>Amount: ‚Çπ${p.amount}</p><p>Type: ${p.payment_type}</p><hr><p>Balance: ${document.getElementById('currentBalance').innerText}</p>`;
        document.getElementById('p1').innerHTML = html;
        document.getElementById('p2').innerHTML = html;
        window.print();
    }

    window.onload = () => { loadParties(); fetchPayments(); };
</script>
</body>
</html>
