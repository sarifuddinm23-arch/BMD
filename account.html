<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMD - Accounts</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #f39c12; --dark: #1a1a1a; --bg: #f4f4f9; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); }
        .top-bar { background: var(--dark); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index: 100; }
        
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        
        /* Account Card Style */
        .acc-card { 
            background: white; padding: 15px; border-radius: 12px; 
            display: flex; align-items: center; gap: 15px; margin-bottom: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer;
            transition: 0.2s; border: 1px solid transparent;
        }
        .acc-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .acc-card img { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; background: #eee; }
        .acc-info { flex-grow: 1; }
        .acc-info h3 { margin: 0; font-size: 17px; color: var(--dark); }
        .acc-info p { margin: 3px 0 0; font-size: 13px; color: #777; }
        
        .balance-tag { text-align: right; }
        .balance-tag span { display: block; font-size: 10px; color: #888; text-transform: uppercase; }
        .balance-tag b { font-size: 15px; color: #e74c3c; }

        /* Floating Add Button */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; border: none; }

        /* Form Overlay */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .form-box { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 15px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="top-bar">
    <span onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i> BMD ACCOUNTS</span>
    <i class="fas fa-search"></i>
</div>

<div class="container" id="accList">
    <p style="text-align:center; padding-top:50px; color:#888;">লোড হচ্ছে...</p>
</div>

<button class="fab" onclick="document.getElementById('addForm').style.display='flex'"><i class="fas fa-user-plus"></i></button>

<div class="overlay" id="addForm">
    <div class="form-box">
        <h2 style="margin-top:0;">নতুন অ্যাকাউন্ট</h2>
        <input type="text" id="name" placeholder="পুরো নাম">
        <input type="number" id="mobile" placeholder="মোবাইল নম্বর">
        <input type="text" id="address" placeholder="ঠিকানা">
        <button class="btn-save" onclick="saveAccount()">তৈরি করুন</button>
        <button onclick="document.getElementById('addForm').style.display='none'" style="background:none; border:none; color:red; width:100%; margin-top:10px; cursor:pointer;">বন্ধ করুন</button>
    </div>
</div>

<script>
    async function loadAccounts() {
        const { data, error } = await supabaseClient.from('accounts').select('*').order('created_at', {ascending: false});
        if (error) return;

        const list = document.getElementById('accList');
        list.innerHTML = '';

        data.forEach(acc => {
            list.innerHTML += `
                <div class="acc-card" onclick="window.location.href='profile.html?id=${acc.id}'">
                    <img src="https://ui-avatars.com/api/?name=${acc.name}&background=random" alt="user">
                    <div class="acc-info">
                        <h3>${acc.name}</h3>
                        <p><i class="fas fa-phone"></i> ${acc.mobile}</p>
                    </div>
                    <div class="balance-tag">
                        <span>Total Due</span>
                        <b id="bal-${acc.id}">₹ 0.00</b>
                    </div>
                </div>
            `;
            updateBalance(acc.id);
        });
    }

    async function updateBalance(accId) {
        // এই ফাংশনটি প্রত্যেকটি একাউন্টের মোট বাকি হিসাব করে দেখাবে
        const { data: trans } = await supabaseClient.from('transactions').select('due_amount').eq('party_id', accId);
        const { data: pays } = await supabaseClient.from('payments').select('amount, payment_type').eq('party_id', accId);
        
        let totalDue = (trans || []).reduce((sum, t) => sum + (parseFloat(t.due_amount) || 0), 0);
        let paidAdjust = (pays || []).reduce((sum, p) => p.payment_type === 'gave' ? sum - parseFloat(p.amount) : sum + parseFloat(p.amount), 0);
        
        document.getElementById(`bal-${accId}`).innerText = "₹ " + (totalDue - paidAdjust).toFixed(2);
    }

    async function saveAccount() {
        const name = document.getElementById('name').value;
        const mobile = document.getElementById('mobile').value;
        const address = document.getElementById('address').value;

        if(!name || !mobile) return alert("নাম ও মোবাইল দিন!");

        const { error } = await supabaseClient.from('accounts').insert([{ name, mobile, address }]);
        if(error) alert(error.message);
        else {
            document.getElementById('addForm').style.display='none';
            loadAccounts();
        }
    }

    window.onload = loadAccounts;
</script>
</body>
</html>
