<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMD - Accounts Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary: #f39c12; --dark: #1a1a1a; --bg: #f0f2f5; 
            --white: #white; --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); transition: 0.3s; }
        .top-bar { background: var(--dark); padding: 15px 20px; color: white; display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index: 1000; }
        .view-mode-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 12px; }

        .phone-frame { width: 95%; max-width: 420px; margin: 20px auto; transition: all 0.4s ease; }
        .desktop-mode { max-width: 1100px !important; }

        .acc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; padding: 10px 0; }
        .acc-box { background: white; border-radius: 15px; padding: 20px 15px; text-align: center; box-shadow: var(--shadow); cursor: pointer; transition: 0.3s; border-bottom: 4px solid transparent; position: relative; text-decoration: none; color: inherit; display: block; }
        .acc-box:hover { transform: translateY(-5px); border-color: var(--primary); }
        
        .edit-icon { position: absolute; top: 10px; right: 10px; color: var(--primary); background: #fff3e0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 1px solid #ffe0b2; z-index: 10; }

        .acc-box img { width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px; border: 2px solid #eee; object-fit: cover; }
        .acc-box h3 { margin: 10px 0 5px; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .acc-box p { margin: 0; font-size: 12px; color: #777; }
        .acc-box .tag { font-size: 10px; background: #eee; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; font-weight: bold; }
        .acc-box .due-amt { display: block; margin-top: 10px; font-weight: bold; color: #e74c3c; font-size: 14px; }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 5px 20px rgba(243, 156, 18, 0.4); cursor: pointer; border: none; z-index: 999; }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; overflow-y: auto; }
        .form-container { width: 100%; max-width: 400px; margin: 0 auto; padding: 20px; box-sizing: border-box; }
        .form-header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; font-size: 15px; box-sizing: border-box; background: white; outline: none; }
        input:focus { border-color: var(--primary); }

        .btn-save { background: var(--dark); color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

<div class="top-bar">
    <span onclick="window.location.href='admin.html'" style="cursor:pointer;"><i class="fas fa-arrow-left"></i> BACK TO DASHBOARD</span>
    <button class="view-mode-btn" onclick="toggleView()"><i class="fas fa-desktop"></i> View Mode</button>
</div>

<div class="phone-frame" id="mainFrame">
    <div class="acc-grid" id="accList">
        <p style="text-align:center; grid-column: 1/-1; color:#aaa;">লোড হচ্ছে...</p>
    </div>
</div>

<button class="fab" onclick="openAddForm()"><i class="fas fa-plus"></i></button>

<div class="overlay" id="addForm">
    <div class="form-container">
        <div class="form-header">
            <i class="fas fa-times" onclick="toggleForm(false)" style="font-size: 20px; cursor:pointer;"></i>
            <h2 id="formTitle">নতুন অ্যাকাউন্ট তৈরি</h2>
        </div>

        <input type="hidden" id="editId">

        <div class="input-group">
            <label>প্রোফাইল ছবি (Profile Image)</label>
            <input type="file" id="imageInput" accept="image/*">
            <input type="hidden" id="imageUrl">
        </div>

        <div class="input-group">
            <label>নাম (Full Name)</label>
            <input type="text" id="name" placeholder="উদা: আব্দুল করিম">
        </div>

        <div class="input-group">
            <label>অ্যাকাউন্ট টাইপ (Type)</label>
            <select id="accType">
                <option value="Retailer">Retailer (খুচরা বিক্রেতা)</option>
                <option value="Wholesaler">Wholesaler (পাইকারি)</option>
                <option value="Distributor">Distributor</option>
                <option value="Seller">Seller</option>
            </select>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="input-group">
                <label>মোবাইল (Mobile)</label>
                <input type="number" id="mobile" placeholder="017xxxxxxxx">
            </div>
            <div class="input-group">
                <label>ইমেইল (Mail ID)</label>
                <input type="email" id="email" placeholder="example@mail.com">
            </div>
        </div>

        <div class="input-group">
            <label>ঠিকানা (Address)</label>
            <input type="text" id="address" placeholder="গ্রাম, পোস্ট অফিস">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="input-group">
                <label>পিন কোড (PIN)</label>
                <input type="number" id="pin" placeholder="74xxxx">
            </div>
            <div class="input-group">
                <label>রাজ্য (State)</label>
                <select id="state">
                    <option value="West Bengal">West Bengal</option>
                    <option value="Assam">Assam</option>
                    <option value="Bihar">Bihar</option>
                    <option value="Odisha">Odisha</option>
                </select>
            </div>
        </div>

        <button class="btn-save" onclick="saveAccount()" id="saveBtn">অ্যাকাউন্ট সেভ করুন</button>
    </div>
</div>

<script>
    let editMode = false;

    function toggleView() { document.getElementById('mainFrame').classList.toggle('desktop-mode'); }
    function toggleForm(show) { document.getElementById('addForm').style.display = show ? 'block' : 'none'; }

    function openAddForm() {
        editMode = false;
        document.getElementById('formTitle').innerText = "নতুন অ্যাকাউন্ট তৈরি";
        document.getElementById('editId').value = "";
        document.querySelectorAll('#addForm input').forEach(i => i.value = '');
        toggleForm(true);
    }

    document.getElementById('imageInput').addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => document.getElementById('imageUrl').value = e.target.result;
            reader.readAsDataURL(file);
        }
    });

    async function loadAccounts() {
        const { data, error } = await supabaseClient.from('accounts').select('*').order('name', {ascending: true});
        if (error) return;

        const list = document.getElementById('accList');
        list.innerHTML = '';

        data.forEach(acc => {
            const avatar = acc.image_url || `https://ui-avatars.com/api/?name=${acc.name}&background=random&color=fff`;
            list.innerHTML += `
                <div class="acc-box">
                    <div class="edit-icon" onclick="event.stopPropagation(); editAccount('${acc.id}')"><i class="fas fa-pen"></i></div>
                    <a href="profile.html?name=${encodeURIComponent(acc.name)}" style="text-decoration:none; color:inherit;">
                        <img src="${avatar}" alt="user">
                        <span class="tag">${acc.acc_type || 'Retailer'}</span>
                        <h3>${acc.name}</h3>
                        <p><i class="fas fa-phone-alt"></i> ${acc.mobile}</p>
                        <p><i class="fas fa-envelope"></i> ${acc.email || 'No Mail'}</p>
                        <span class="due-amt" id="bal-${acc.id}">₹ 0.00</span>
                    </a>
                </div>
            `;
            updateBalance(acc.id);
        });
    }

    async function editAccount(id) {
        editMode = true;
        toggleForm(true);
        document.getElementById('formTitle').innerText = "অ্যাকাউন্ট এডিট করুন";
        
        const { data } = await supabaseClient.from('accounts').select('*').eq('id', id).single();
        if (data) {
            document.getElementById('editId').value = data.id;
            document.getElementById('name').value = data.name;
            document.getElementById('mobile').value = data.mobile;
            document.getElementById('email').value = data.email || '';
            document.getElementById('address').value = data.address || '';
            document.getElementById('pin').value = data.pin || '';
            document.getElementById('state').value = data.state || 'West Bengal';
            document.getElementById('accType').value = data.acc_type || 'Retailer';
            document.getElementById('imageUrl').value = data.image_url || '';
        }
    }

    async function saveAccount() {
        const id = document.getElementById('editId').value;
        const name = document.getElementById('name').value;
        const mobile = document.getElementById('mobile').value;
        const email = document.getElementById('email').value;
        const address = document.getElementById('address').value;
        const pin = document.getElementById('pin').value;
        const state = document.getElementById('state').value;
        const acc_type = document.getElementById('accType').value;
        const image_url = document.getElementById('imageUrl').value;
        const btn = document.getElementById('saveBtn');

        if(!name || !mobile) return alert("দয়া করে নাম ও মোবাইল দিন!");

        btn.disabled = true;
        btn.innerText = "সেভ হচ্ছে...";

        const payload = { name, mobile, email, address, pin, state, acc_type, image_url };

        let result;
        if (editMode) {
            result = await supabaseClient.from('accounts').update(payload).eq('id', id);
        } else {
            result = await supabaseClient.from('accounts').insert([payload]);
        }

        if(result.error) {
            alert("ভুল হয়েছে: " + result.error.message);
        } else {
            alert(editMode ? "এডিট সফল! ✅" : "অ্যাকাউন্ট তৈরি সফল! ✅");
            toggleForm(false);
            loadAccounts();
        }
        btn.disabled = false;
        btn.innerText = "অ্যাকাউন্ট সেভ করুন";
    }

    async function updateBalance(accId) {
        document.getElementById(`bal-${accId}`).innerText = "₹ 0.00"; 
    }

    window.onload = loadAccounts;
</script>
</body>
</html>
