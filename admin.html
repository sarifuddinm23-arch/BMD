<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Admin Dashboard - My Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link:hover { background-color: #374151; border-left: 4px solid #3b82f6; }
        .active-link { background-color: #1f2937; border-left: 4px solid #3b82f6; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-100">

    <script>
        const adminUID = "f0a78810-62f3-48b8-b233-dfdd07cd5041";
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session || session.user.id !== adminUID) {
                window.location.href = "admin_login.html";
            }
        }
        checkAuth();
    </script>

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-gray-900 text-white flex flex-col transition-all duration-300">
            <div class="p-6 text-2xl font-bold border-b border-gray-800 flex items-center gap-3">
                <i class="fas fa-chart-line text-blue-500"></i>
                <span>My Manager</span>
            </div>
            
            <nav class="flex-1 mt-4 px-2 space-y-1 overflow-y-auto">
                <a href="admin.html" class="sidebar-link active-link flex items-center p-3 rounded-lg transition">
                    <i class="fas fa-home w-6"></i> <span>Dashboard</span>
                </a>
                <a href="account.html" class="sidebar-link flex items-center p-3 rounded-lg transition text-gray-400 hover:text-white">
                    <i class="fas fa-user-tie w-6"></i> <span>Accounts</span>
                </a>
                <a href="Transactions.html" class="sidebar-link flex items-center p-3 rounded-lg transition text-gray-400 hover:text-white">
                    <i class="fas fa-exchange-alt w-6"></i> <span>Transactions</span>
                </a>
                <a href="data.html" class="sidebar-link flex items-center p-3 rounded-lg transition text-gray-400 hover:text-white">
                    <i class="fas fa-database w-6"></i> <span>Master Data</span>
                </a>
                <div class="border-t border-gray-800 my-4"></div>
                <button onclick="logout()" class="w-full bg-red-600/10 hover:bg-red-600 p-3 rounded-lg flex items-center gap-3 text-red-500 hover:text-white transition group">
                    <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                </button>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Control Center</h1>
                    <p class="text-gray-500 text-sm">Welcome back, Administrator</p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="bg-white p-2 rounded-xl shadow-sm px-4 text-sm font-semibold text-gray-600 border border-gray-200">
                        <i class="fas fa-calendar-day text-blue-500 mr-2"></i> <span id="currentDate"></span>
                    </span>
                    <img src="https://ui-avatars.com/api/?name=Admin&background=1e293b&color=fff" class="w-10 h-10 rounded-full border-2 border-white shadow-md">
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-green-500">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-400 uppercase font-black mb-1">Total Sales</p>
                            <h3 id="statSales" class="text-2xl font-bold text-gray-800">₹ 0.00</h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg text-green-600"><i class="fas fa-shopping-bag text-xl"></i></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-orange-500">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-400 uppercase font-black mb-1">Total Purchase</p>
                            <h3 id="statPurchase" class="text-2xl font-bold text-gray-800">₹ 0.00</h3>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-lg text-orange-600"><i class="fas fa-truck-loading text-xl"></i></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-red-500">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-400 uppercase font-black mb-1">Balance Due</p>
                            <h3 id="statDue" class="text-2xl font-bold text-red-600">₹ 0.00</h3>
                        </div>
                        <div class="bg-red-100 p-3 rounded-lg text-red-600"><i class="fas fa-wallet text-xl"></i></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Recent Transactions</h2>
                    <button onclick="loadDashboardData()" class="text-blue-600 hover:rotate-180 transition duration-500">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                            <tr>
                                <th class="p-4">Date</th>
                                <th class="p-4">Customer/Item</th>
                                <th class="p-4">Type</th>
                                <th class="p-4 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="activityList" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                    <div id="loader" class="p-10 text-center text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i> Fetching data...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Set Today's Date
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

        async function loadDashboardData() {
            document.getElementById('loader').classList.remove('hidden');
            
            try {
                // 1. Fetch all Transactions
                const { data: trans, error: tErr } = await supabaseClient.from('transactions').select('*').order('created_at', {ascending: false});
                // 2. Fetch all Payments
                const { data: pays, error: pErr } = await supabaseClient.from('payments').select('*');

                if(tErr || pErr) throw tErr || pErr;

                let sales = 0, purchase = 0, totalDue = 0;

                // Calculation logic
                if(trans) {
                    trans.forEach(t => {
                        const val = parseFloat(t.total || 0);
                        if(t.type === 'sell') sales += val;
                        if(t.type === 'received') purchase += val;
                        totalDue += parseFloat(t.due || 0);
                    });
                }

                if(pays) {
                    pays.forEach(p => {
                        if(p.action === 'received') totalDue -= parseFloat(p.total_amt || 0);
                        if(p.action === 'payout') totalDue += parseFloat(p.total_amt || 0);
                    });
                }

                // Update UI Counters
                document.getElementById('statSales').innerText = "₹ " + sales.toLocaleString('en-IN', {minimumFractionDigits: 2});
                document.getElementById('statPurchase').innerText = "₹ " + purchase.toLocaleString('en-IN', {minimumFractionDigits: 2});
                document.getElementById('statDue').innerText = "₹ " + totalDue.toLocaleString('en-IN', {minimumFractionDigits: 2});

                // Render Table (Last 10)
                renderTable(trans.slice(0, 10));

            } catch (err) {
                console.error("Dashboard Error:", err);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('activityList');
            if(!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-10 text-center text-gray-400">No transactions found</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="p-4 text-sm text-gray-500">${new Date(item.created_at).toLocaleDateString('en-IN')}</td>
                    <td class="p-4">
                        <div class="font-bold text-gray-800">${item.product_name}</div>
                        <div class="text-xs text-gray-400">${item.mobile}</div>
                    </td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${item.type === 'sell' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                            ${item.type}
                        </span>
                    </td>
                    <td class="p-4 text-right font-bold ${item.type === 'sell' ? 'text-green-600' : 'text-blue-600'}">
                        ₹ ${parseFloat(item.total).toLocaleString('en-IN')}
                    </td>
                </tr>
            `).join('');
        }

        async function logout() {
            if(confirm("Are you sure you want to logout?")) {
                await supabaseClient.auth.signOut();
                window.location.href = "admin_login.html";
            }
        }

        // Run on load
        window.onload = loadDashboardData;
    </script>
</body>
</html>
