<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMD Admin - My Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link:hover { background-color: #374151; border-left: 4px solid #f39c12; }
        .active-link { background-color: #1f2937; border-left: 4px solid #f39c12; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body class="bg-gray-100">

    <script>
        const adminUID = "f0a78810-62f3-48b8-b233-dfdd07cd5041";
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session || session.user.id !== adminUID) {
                window.location.href = "admin_login.html";
            }
        }
        checkAuth();
    </script>

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-gray-900 text-white flex flex-col transition-all duration-300">
            <div class="p-6 text-2xl font-bold border-b border-gray-800 flex items-center gap-3">
                <i class="fas fa-chart-line text-orange-500"></i>
                <span>My Manager</span>
            </div>
            
            <nav class="flex-1 mt-4 px-2 space-y-1 overflow-y-auto">
                <a href="admin.html" class="sidebar-link active-link flex items-center p-3 rounded-lg transition">
                    <i class="fas fa-home w-6"></i> <span>Dashboard</span>
                </a>
                <a href="account.html" class="sidebar-link flex items-center p-3 rounded-lg transition text-gray-400 hover:text-white">
                    <i class="fas fa-user-tie w-6"></i> <span>Accounts</span>
                </a>
                <a href="Transactions.html" class="sidebar-link flex items-center p-3 rounded-lg transition text-gray-400 hover:text-white">
                    <i class="fas fa-exchange-alt w-6"></i> <span>Transactions</span>
                </a>
                
                <div class="pt-2">
                    <p class="px-4 text-[10px] uppercase font-bold text-gray-500 mb-2">Inventory Control</p>
                    <a href="data.html" class="sidebar-link flex items-center p-3 rounded-lg transition text-gray-400 hover:text-white">
                        <i class="fas fa-database w-6"></i> <span>Master Data</span>
                    </a>
                </div>

                <div class="border-t border-gray-800 my-4"></div>
                
                <p class="px-4 text-[10px] uppercase font-bold text-gray-500 mb-2">My Businesses</p>
                <a href="ckart.html" class="sidebar-link flex items-center p-3 rounded-lg transition text-gray-400 hover:text-white">
                    <i class="fas fa-shopping-cart w-6"></i> <span>My Ckart Business</span>
                </a>
                <a href="oil.html" class="sidebar-link flex items-center p-3 rounded-lg transition text-gray-400 hover:text-white">
                    <i class="fas fa-oil-can w-6"></i> <span>My Oil Business</span>
                </a>
                <a href="setting.html" class="sidebar-link flex items-center p-3 rounded-lg transition text-gray-400 hover:text-white">
                    <i class="fas fa-cog w-6"></i> <span>Settings</span>
                </a>

                <button onclick="logout()" class="w-full mt-8 bg-red-600/10 hover:bg-red-600 p-3 rounded-lg flex items-center gap-3 text-red-500 hover:text-white transition">
                    <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                </button>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Control Center</h1>
                    <p class="text-gray-500 text-sm">ব্যবসার বর্তমান অবস্থা একনজরে দেখুন</p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="bg-white p-2 rounded-xl shadow-sm px-4 text-sm font-semibold text-gray-600 border border-gray-200">
                        <i class="fas fa-calendar-day text-orange-500 mr-2"></i> <span id="currentDate"></span>
                    </span>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-blue-500 stat-card">
                    <p class="text-xs text-gray-400 uppercase font-black">Total Products</p>
                    <h3 id="totalProducts" class="text-2xl font-bold text-gray-800">0</h3>
                    <p class="text-[10px] text-gray-400 mt-1" id="totalCats">0 Categories</p>
                </div>
                
                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-orange-500 stat-card">
                    <p class="text-xs text-gray-400 uppercase font-black">Purchase Value</p>
                    <h3 id="purchasePrice" class="text-xl font-bold text-gray-800">₹ 0.00</h3>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-green-500 stat-card">
                    <p class="text-xs text-gray-400 uppercase font-black">Stock Net Value</p>
                    <h3 id="netPrice" class="text-xl font-bold text-gray-800">₹ 0.00</h3>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-purple-500 stat-card">
                    <p class="text-xs text-gray-400 uppercase font-black">Total Accounts</p>
                    <h3 id="totalAccs" class="text-2xl font-bold text-gray-800">0</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-red-50 p-6 rounded-2xl border border-red-100 flex items-center justify-between">
                    <div>
                        <p class="text-sm text-red-600 font-bold uppercase">Total Payable (আমি দেব)</p>
                        <h2 id="duePayable" class="text-3xl font-black text-red-700">₹ 0.00</h2>
                    </div>
                    <i class="fas fa-arrow-up text-red-300 text-4xl"></i>
                </div>

                <div class="bg-green-50 p-6 rounded-2xl border border-green-100 flex items-center justify-between">
                    <div>
                        <p class="text-sm text-green-600 font-bold uppercase">Total Receivable (আমি পাব)</p>
                        <h2 id="dueReceivable" class="text-3xl font-black text-green-700">₹ 0.00</h2>
                    </div>
                    <i class="fas fa-arrow-down text-green-300 text-4xl"></i>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Recent Transactions</h2>
                    <button onclick="loadDashboardData()" class="bg-gray-100 p-2 rounded-lg hover:bg-gray-200 transition">
                        <i class="fas fa-sync-alt text-gray-600"></i>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-500 text-[10px] uppercase">
                            <tr>
                                <th class="p-4">Date</th>
                                <th class="p-4">Item / Party</th>
                                <th class="p-4">Type</th>
                                <th class="p-4 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="activityList" class="divide-y divide-gray-100 text-sm"></tbody>
                    </table>
                    <div id="loader" class="p-10 text-center text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i> Syncing Data...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

        async function loadDashboardData() {
            document.getElementById('loader').classList.remove('hidden');
            try {
                // 1. Fetch Accounts
                const { data: accs } = await supabaseClient.from('accounts').select('id');
                document.getElementById('totalAccs').innerText = accs ? accs.length : 0;

                // 2. Fetch Products & Categories (Master Data)
                const { data: products } = await supabaseClient.from('product_list').select('*');
                if(products) {
                    document.getElementById('totalProducts').innerText = products.length;
                    const cats = [...new Set(products.map(p => p.category_id))];
                    document.getElementById('totalCats').innerText = cats.length + " Categories";
                    
                    let pValue = products.reduce((s, p) => s + (parseFloat(p.purchase_price || 0) * (p.stock || 0)), 0);
                    let nValue = products.reduce((s, p) => s + (parseFloat(p.sell_price || 0) * (p.stock || 0)), 0);
                    
                    document.getElementById('purchasePrice').innerText = "₹ " + pValue.toLocaleString('en-IN');
                    document.getElementById('netPrice').innerText = "₹ " + nValue.toLocaleString('en-IN');
                }

                // 3. Fetch Transactions for Due Calculations
                const { data: trans } = await supabaseClient.from('transactions').select('*').order('created_at', {ascending: false});
                
                let receivable = 0; // আমি পাব (Sales Due)
                let payable = 0;    // আমি দেব (Purchase Due)

                if(trans) {
                    trans.forEach(t => {
                        const due = parseFloat(t.due || 0);
                        if(t.type === 'sell') receivable += due;
                        if(t.type === 'received') payable += due;
                    });
                    renderTable(trans.slice(0, 8));
                }

                document.getElementById('dueReceivable').innerText = "₹ " + receivable.toLocaleString('en-IN');
                document.getElementById('duePayable').innerText = "₹ " + payable.toLocaleString('en-IN');

            } catch (err) {
                console.error(err);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('activityList');
            tbody.innerHTML = data.map(item => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="p-4 text-gray-500 text-xs">${new Date(item.created_at).toLocaleDateString('en-IN')}</td>
                    <td class="p-4">
                        <div class="font-bold text-gray-800">${item.product_name || 'N/A'}</div>
                        <div class="text-[10px] text-gray-400">${item.mobile || ''}</div>
                    </td>
                    <td class="p-4">
                        <span class="px-2 py-0.5 rounded text-[9px] font-bold uppercase ${item.type === 'sell' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${item.type}
                        </span>
                    </td>
                    <td class="p-4 text-right font-bold text-gray-700">₹ ${parseFloat(item.total || 0).toLocaleString('en-IN')}</td>
                </tr>
            `).join('');
        }

        async function logout() {
            if(confirm("Logout from My Manager?")) {
                await supabaseClient.auth.signOut();
                window.location.href = "admin_login.html";
            }
        }

        window.onload = loadDashboardData;
    </script>
</body>
</html>
