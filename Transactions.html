<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMD - Transactions</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    
    <style>
        :root { --primary: #f39c12; --dark: #1a1a1a; --bg: #f4f4f9; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); }
        .top-bar { background: var(--dark); padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .container { max-width: 900px; margin: 20px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; color: #444; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        input:focus, select:focus { border-color: var(--primary); outline: none; background: #fffdf5; }
        
        .calc-box { background: #fef9e7; padding: 15px; border-radius: 8px; border: 1px dashed var(--primary); margin-bottom: 20px; }
        .calc-box p { margin: 5px 0; font-weight: bold; }

        .btn-save { background: var(--dark); color: var(--primary); border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; transition: 0.3s; }
        .btn-save:hover { background: #000; }

        .table-container { overflow-x: auto; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: var(--dark); color: white; }
        .status-sell { color: #e67e22; font-weight: bold; }
        .status-receive { color: #27ae60; font-weight: bold; }
    </style>
</head>
<body>

<div class="top-bar">
    <span onclick="window.location.href='index.html'" style="cursor:pointer; font-weight: bold;">⬅️ BMD TRANSACTIONS</span>
    <div id="status">Online</div>
</div>

<div class="container">
    <h3 style="margin-top: 0; color: var(--dark);">New Entry (কেনা বা বিক্রি)</h3>
    
    <form id="transForm">
        <div class="form-grid">
            <div>
                <label>Select Oil Seller / Party *</label>
                <select id="partySelect" required onchange="getSellerPrice()">
                    <option value="">Choose Seller</option>
                </select>
            </div>
            <div>
                <label>Transaction Type *</label>
                <select id="type" required>
                    <option value="sell">Sell (বিক্রি)</option>
                    <option value="receive">Purchase (কেনা/ক্রয়)</option>
                </select>
            </div>
            <div>
                <label>Product</label>
                <select id="product">
                    <option value="Petrol">Petrol</option>
                    <option value="Diesel">Diesel</option>
                    <option value="Mustard Oil">Mustard Oil</option>
                    <option value="Cake (Khail)">Cake (Khail)</option>
                </select>
            </div>
            <div>
                <label>Quantity (Ltr/Kg) *</label>
                <input type="number" id="qty" step="0.01" placeholder="0.00" required oninput="calculate()">
            </div>
            <div>
                <label>Rate (per Ltr/Kg) *</label>
                <input type="number" id="rate" step="0.01" placeholder="₹ 0.00" required oninput="calculate()">
            </div>
            <div>
                <label>Payment Paid/Received</label>
                <input type="number" id="paid" step="0.01" placeholder="₹ 0.00" oninput="calculate()">
            </div>
        </div>

        <div class="calc-box">
            <p>Total Bill: ₹ <span id="net_total">0.00</span></p>
            <p style="color: red;">Due Amount: ₹ <span id="due_amount">0.00</span></p>
        </div>
        
        <button type="button" class="btn-save" id="saveBtn" onclick="saveTransaction()">SAVE TRANSACTION</button>
    </form>

    <div class="table-container">
        <h3>Recent Transactions</h3>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Seller Name</th>
                    <th>Type</th>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Total</th>
                    <th>Paid</th>
                    <th>Due</th>
                </tr>
            </thead>
            <tbody id="transListBody">
                </tbody>
        </table>
    </div>
</div>

<script>
    // ১. লোড সেলার ড্রপডাউন
    async function loadSellers() {
        const { data, error } = await supabaseClient.from('parties').select('id, first_name, set_price');
        if (data) {
            const select = document.getElementById('partySelect');
            data.forEach(p => {
                select.innerHTML += `<option value="${p.id}" data-price="${p.set_price}">${p.first_name}</option>`;
            });
        }
    }

    // ২. সেলার সিলেক্ট করলে অটো রেট বসানো
    function getSellerPrice() {
        const select = document.getElementById('partySelect');
        const price = select.options[select.selectedIndex].getAttribute('data-price');
        if(price > 0) {
            document.getElementById('rate').value = price;
            calculate();
        }
    }

    // ৩. হিসাব করা
    function calculate() {
        const qty = parseFloat(document.getElementById('qty').value) || 0;
        const rate = parseFloat(document.getElementById('rate').value) || 0;
        const paid = parseFloat(document.getElementById('paid').value) || 0;
        
        const total = qty * rate;
        const due = total - paid;
        
        document.getElementById('net_total').innerText = total.toFixed(2);
        document.getElementById('due_amount').innerText = due.toFixed(2);
    }

    // ৪. ট্রানজাকশন সেভ করা
    async function saveTransaction() {
        const btn = document.getElementById('saveBtn');
        const data = {
            party_id: document.getElementById('partySelect').value,
            type: document.getElementById('type').value,
            product: document.getElementById('product').value,
            qty: parseFloat(document.getElementById('qty').value),
            rate: parseFloat(document.getElementById('rate').value),
            net_total: parseFloat(document.getElementById('net_total').innerText),
            paid_amount: parseFloat(document.getElementById('paid').value) || 0,
            due_amount: parseFloat(document.getElementById('due_amount').innerText),
            created_at: new Date()
        };

        if(!data.party_id || !data.qty || !data.rate) {
            alert("Please fill all required fields!");
            return;
        }

        btn.disabled = true;
        btn.innerText = "Saving...";

        const { error } = await supabaseClient.from('transactions').insert([data]);
        
        if (error) {
            alert("Error: " + error.message);
        } else {
            alert("Transaction Saved! ✅");
            document.getElementById('transForm').reset();
            fetchTransactions();
        }
        btn.disabled = false;
        btn.innerText = "SAVE TRANSACTION";
    }

    // ৫. ট্রানজাকশন লিস্ট দেখানো
    async function fetchTransactions() {
        const { data, error } = await supabaseClient
            .from('transactions')
            .select(`*, parties(first_name)`)
            .order('created_at', { ascending: false });

        if (data) {
            const tbody = document.getElementById('transListBody');
            tbody.innerHTML = '';
            data.forEach(t => {
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(t.created_at).toLocaleDateString()}</td>
                        <td>${t.parties ? t.parties.first_name : 'N/A'}</td>
                        <td class="status-${t.type}">${t.type.toUpperCase()}</td>
                        <td>${t.product}</td>
                        <td>${t.qty}</td>
                        <td>₹${t.net_total}</td>
                        <td>₹${t.paid_amount}</td>
                        <td style="color:red">₹${t.due_amount}</td>
                    </tr>
                `;
            });
        }
    }

    window.onload = () => {
        loadSellers();
        fetchTransactions();
    };
</script>
</body>
</html>
