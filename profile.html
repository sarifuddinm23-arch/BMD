<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Profile - BMD</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #f39c12; --dark: #1a1a1a; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        .top-bar { background: var(--dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; }
        
        .header-card { background: white; margin: 15px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; }
        .header-card h2 { margin: 5px 0; color: var(--dark); }
        
        /* Stats Box */
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 15px; }
        .stat-box { background: white; padding: 15px; border-radius: 12px; border-bottom: 4px solid #ddd; }
        .stat-box.green { border-color: #27ae60; }
        .stat-box.red { border-color: #e74c3c; }

        /* Statement Table */
        .statement-box { background: white; margin: 15px; border-radius: 15px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #eee; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #f1f1f1; }
        
        .btn-print { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }

        @media print {
            .top-bar, .btn-print { display: none; }
            body { background: white; }
            .statement-box { box-shadow: none; margin: 0; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <i class="fas fa-arrow-left" onclick="history.back()"></i>
    <span>ACCOUNT DASHBOARD</span>
    <button class="btn-print" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
</div>

<div class="header-card">
    <i class="fas fa-user-circle fa-3x" style="color: #ccc;"></i>
    <h2 id="accName">Loading...</h2>
    <p id="accPhone" style="color: #777;"></p>
</div>

<div class="stats-container">
    <div class="stat-box green">
        <small>TOTAL RECEIVED</small>
        <h3 id="totalRec">₹ 0</h3>
    </div>
    <div class="stat-box red">
        <small>TOTAL DUE</small>
        <h3 id="totalDue">₹ 0</h3>
    </div>
</div>

<div class="statement-box">
    <h4 style="padding: 15px; margin: 0; border-bottom: 1px solid #eee;">Statement (All Records)</h4>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Details</th>
                <th>Type</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody id="statementBody">
            </tbody>
    </table>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const accId = urlParams.get('id');

    async function loadProfile() {
        if(!accId) return;

        // 1. Fetch Account Details
        const { data: account } = await supabaseClient.from('accounts').select('*').eq('id', accId).single();
        if(account) {
            document.getElementById('accName').innerText = account.name;
            document.getElementById('accPhone').innerText = account.phone || "No Phone";
        }

        // 2. Fetch Transactions (Sell, Receive, Payment)
        const { data: trans } = await supabaseClient.from('transactions').select('*').eq('party_id', accId).order('created_at', {ascending: false});
        
        let html = '';
        let totalPaid = 0;
        let totalDue = 0;

        trans.forEach(item => {
            totalPaid += parseFloat(item.paid_amount || 0);
            totalDue += parseFloat(item.due_amount || 0);

            html += `
                <tr>
                    <td>${new Date(item.created_at).toLocaleDateString()}</td>
                    <td>${item.product_name || 'Payment'}</td>
                    <td><span style="color:${item.paid_amount > 0 ? 'green' : 'red'}">${item.mother_category || 'Cash'}</span></td>
                    <td>₹ ${item.net_total || item.paid_amount}</td>
                </tr>
            `;
        });

        document.getElementById('statementBody').innerHTML = html;
        document.getElementById('totalRec').innerText = "₹ " + totalPaid.toFixed(2);
        document.getElementById('totalDue').innerText = "₹ " + totalDue.toFixed(2);
    }

    window.onload = loadProfile;
</script>

</body>
</html>
