<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Profile - BMD</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #f39c12; --dark: #1a1a1a; --bg: #f0f2f5; --white: #fff; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); transition: 0.3s; }
        
        /* Top Bar */
        .top-bar { 
            background: var(--dark); color: white; padding: 12px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top:0; z-index: 1000; 
        }
        .mode-btn { 
            background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 12px;
        }

        /* Container & Responsive Mode */
        .container { width: 95%; max-width: 420px; margin: 15px auto; transition: all 0.4s ease; }
        .desktop-view { max-width: 1000px !important; }

        /* Profile Header */
        .profile-card { background: var(--white); border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .profile-card h2 { margin: 10px 0 5px; font-size: 20px; }
        .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .bal-item { padding: 10px; border-radius: 10px; background: #f8f9fa; }
        .bal-item small { font-size: 10px; color: #777; font-weight: bold; }
        .bal-item span { display: block; font-size: 15px; font-weight: bold; }

        /* 4 Action Icons Grid */
        .action-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; 
        }
        .action-btn { 
            background: var(--white); padding: 15px 5px; border-radius: 12px; text-align: center;
            text-decoration: none; color: var(--dark); font-size: 10px; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .action-btn:active { transform: scale(0.95); }
        .action-btn i { display: block; font-size: 20px; margin-bottom: 8px; }
        .action-btn.receive i { color: #2980b9; }
        .action-btn.sell i { color: #e67e22; }
        .action-btn.pay-in i { color: var(--success); }
        .action-btn.pay-out i { color: var(--danger); }

        /* Statement Table */
        .statement-card { background: var(--white); border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .table-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #f8f9fa; padding: 12px 10px; text-align: left; color: #666; }
        td { padding: 12px 10px; border-bottom: 1px solid #f1f1f1; }

        @media print {
            .top-bar, .action-grid, .mode-btn { display: none !important; }
            .container { max-width: 100% !important; width: 100%; margin: 0; }
            .statement-card { box-shadow: none; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <div onclick="history.back()" style="cursor:pointer;"><i class="fas fa-arrow-left"></i> PROFILE</div>
    <button class="mode-btn" onclick="toggleMode()"><i class="fas fa-desktop"></i> Desktop Mode</button>
</div>

<div class="container" id="mainWrapper">
    
    <div class="profile-card">
        <i class="fas fa-user-circle fa-3x" style="color: #ddd;"></i>
        <h2 id="userName">Loading...</h2>
        <div class="balance-grid">
            <div class="bal-item">
                <small>TOTAL PAID</small>
                <span id="txtPaid" style="color: var(--success);">₹ 0</span>
            </div>
            <div class="bal-item">
                <small>NET DUE</small>
                <span id="txtDue" style="color: var(--danger);">₹ 0</span>
            </div>
        </div>
    </div>

    <div class="action-grid">
        <a href="#" class="action-btn receive" onclick="alert('Open Receive Form')">
            <i class="fas fa-truck-loading"></i> RECEIVE
        </a>
        <a href="#" class="action-btn sell" onclick="alert('Open Sell Form')">
            <i class="fas fa-shopping-cart"></i> SELL
        </a>
        <a href="#" class="action-btn pay-in" onclick="alert('Open Payment In Form')">
            <i class="fas fa-hand-holding-usd"></i> PAY-IN
        </a>
        <a href="#" class="action-btn pay-out" onclick="alert('Open Payment Out Form')">
            <i class="fas fa-file-invoice-dollar"></i> PAY-OUT
        </a>
    </div>

    <div class="statement-card">
        <div class="table-header">
            <span style="font-weight: bold;"><i class="fas fa-list"></i> STATEMENT</span>
            <button onclick="window.print()" style="padding: 5px 10px; cursor: pointer;"><i class="fas fa-print"></i> Print</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Product/Note</th>
                    <th>Type</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody id="statementData">
                </tbody>
        </table>
    </div>

</div>

<script>
    function toggleMode() {
        document.getElementById('mainWrapper').classList.toggle('desktop-view');
    }

    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('id');

    async function loadData() {
        if(!userId) return;

        // 1. User Info Load
        const { data: user } = await supabaseClient.from('accounts').select('name').eq('id', userId).single();
        if(user) document.getElementById('userName').innerText = user.name;

        // 2. Transactions Load
        const { data: trans } = await supabaseClient.from('transactions')
            .select('*')
            .eq('party_id', userId)
            .order('created_at', { ascending: false });

        let tableHtml = '';
        let totalPaid = 0;
        let totalDue = 0;

        trans.forEach(row => {
            totalPaid += parseFloat(row.paid_amount || 0);
            totalDue += parseFloat(row.due_amount || 0);

            tableHtml += `
                <tr>
                    <td>${new Date(row.created_at).toLocaleDateString()}</td>
                    <td>${row.product_name || 'Cash Entry'}</td>
                    <td><b>${row.mother_category || 'Payment'}</b></td>
                    <td>₹ ${row.net_total || row.paid_amount}</td>
                </tr>
            `;
        });

        document.getElementById('statementData').innerHTML = tableHtml || '<tr><td colspan="4" style="text-align:center">No Data Found</td></tr>';
        document.getElementById('txtPaid').innerText = "₹ " + totalPaid.toLocaleString();
        document.getElementById('txtDue').innerText = "₹ " + totalDue.toLocaleString();
    }

    window.onload = loadData;
</script>

</body>
</html>
