<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Profile Dashboard - BMD</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2ecc71; --warning: #f39c12; --dark: #0f172a; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        
        .header { background: var(--dark); color: white; padding: 20px; display: flex; align-items: center; gap: 15px; }
        
        /* Dashboard Grid Layout */
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid #ddd; }
        .box.wide { grid-column: span 2; }
        .box small { color: #64748b; font-weight: bold; text-transform: uppercase; font-size: 11px; }
        .box h2 { margin: 8px 0 2px; font-size: 20px; color: #1e293b; }
        .box .sub-info { font-size: 12px; color: var(--warning); font-weight: bold; }

        /* Color Variants */
        .border-green { border-bottom-color: #2ecc71; }
        .border-blue { border-bottom-color: #3498db; }
        .border-orange { border-bottom-color: #f39c12; }
        .border-red { border-bottom-color: #e74c3c; }

        .btn-pay { background: var(--dark); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        
        /* Modal Style */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 20px; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="header">
    <i class="fas fa-arrow-left" onclick="history.back()"></i>
    <div><h3 id="profileName" style="margin:0">Account Name</h3><small id="profileContact"></small></div>
</div>

<div class="dashboard-grid">
    <div class="box border-blue">
        <small>Total Received Qty</small>
        <h2 id="liveQty">0</h2>
        <div class="sub-info" id="liveUnit">UNIT</div>
    </div>

    <div class="box border-green">
        <small>Avg. Unit Price</small>
        <h2 id="liveUnitPrice">₹ 0</h2>
        <div class="sub-info">Per Unit</div>
    </div>

    <div class="box wide border-orange">
        <small>Total Product Value</small>
        <h2 id="liveTotalValue" style="font-size: 28px;">₹ 0.00</h2>
    </div>

    <div class="box border-blue">
        <small>Last Payment</small>
        <h2 id="lastPayAmt">₹ 0</h2>
        <div class="sub-info" id="lastPayMode">MODE</div>
    </div>

    <div class="box border-red">
        <small>Total Due Balance</small>
        <h2 id="liveDue" style="color: #e74c3c;">₹ 0.00</h2>
        <div class="sub-info">Pending</div>
    </div>
</div>

<div style="padding: 0 15px;">
    <button class="btn-pay" onclick="openModal()"><i class="fas fa-wallet"></i> ADD NEW PAYMENT</button>
</div>

<div class="overlay" id="payModal">
    <div class="modal">
        <h3>Payment Entry</h3>
        <input type="date" id="payDate">
        <select id="payStatus">
            <option value="Received">Received (আমি পেলাম)</option>
            <option value="Payout">Payout (আমি দিলাম)</option>
        </select>
        <input type="number" id="payAmount" placeholder="Amount (টাকা)">
        <select id="payMode">
            <option value="Cash">Cash</option>
            <option value="Online">Online</option>
        </select>
        <button class="btn-pay" onclick="savePayment()" id="saveBtn">SAVE PAYMENT</button>
        <button onclick="closeModal()" style="width:100%; background:none; border:none; margin-top:10px; color:gray;">Cancel</button>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const accName = urlParams.get('name');
    let currentDue = 0;

    async function loadDashboard() {
        if(!accName) return;

        // 1. Get Account & Product Info
        const { data: acc } = await supabaseClient.from('accounts').select('*').eq('name', accName).single();
        if(acc) {
            document.getElementById('profileName').innerText = acc.name;
            document.getElementById('profileContact').innerText = acc.mobile;
        }

        const { data: products } = await supabaseClient.from('received_products').select('*').eq('supplier_name', accName);
        
        let totalQty = 0;
        let totalVal = 0;
        let unitType = "Unit";
        let unitPrice = 0;

        if(products && products.length > 0) {
            products.forEach(p => {
                totalQty += parseFloat(p.quantity || 0);
                totalVal += parseFloat(p.total_price || 0);
                unitType = p.unit || "Unit";
            });
            unitPrice = totalVal / totalQty;
        }

        document.getElementById('liveQty').innerText = totalQty;
        document.getElementById('liveUnit').innerText = unitType;
        document.getElementById('liveUnitPrice').innerText = "₹ " + unitPrice.toFixed(2);
        document.getElementById('liveTotalValue').innerText = "₹ " + totalVal.toFixed(2);

        // 2. Get Payment History
        const { data: pays } = await supabaseClient.from('payments').select('*').eq('acc_name', accName).order('payment_date', {ascending: true});
        
        let paidTotal = 0;
        let lastAmt = 0;
        let lastMode = "N/A";

        if(pays && pays.length > 0) {
            pays.forEach(p => {
                if(p.status === 'Received') paidTotal += parseFloat(p.amount);
                else paidTotal -= parseFloat(p.amount);
            });
            const lastRow = pays[pays.length - 1];
            lastAmt = lastRow.amount;
            lastMode = lastRow.mode;
        }

        document.getElementById('lastPayAmt').innerText = "₹ " + lastAmt;
        document.getElementById('lastPayMode').innerText = lastMode.toUpperCase();
        
        // Final Calculation
        currentDue = totalVal - paidTotal;
        document.getElementById('liveDue').innerText = "₹ " + currentDue.toFixed(2);
    }

    function openModal() { 
        document.getElementById('payModal').style.display = 'flex'; 
        document.getElementById('payDate').valueAsDate = new Date();
    }
    function closeModal() { document.getElementById('payModal').style.display = 'none'; }

    async function savePayment() {
        const amt = parseFloat(document.getElementById('payAmount').value);
        const date = document.getElementById('payDate').value;
        const status = document.getElementById('payStatus').value;
        const mode = document.getElementById('payMode').value;

        if(!amt) return alert("টাকার পরিমাণ লিখুন");

        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerText = "Saving...";

        const { error } = await supabaseClient.from('payments').insert([{
            acc_name: accName,
            payment_date: date,
            status: status,
            amount: amt,
            mode: mode,
            balance: status === 'Received' ? (currentDue - amt) : (currentDue + amt)
        }]);

        if(error) alert(error.message);
        else {
            closeModal();
            loadDashboard();
        }
        btn.disabled = false;
        btn.innerText = "SAVE PAYMENT";
    }

    window.onload = loadDashboard;
</script>
</body>
</html>
